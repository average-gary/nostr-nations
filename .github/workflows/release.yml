name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Create draft release first
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      release_upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate release notes from CHANGELOG
        id: changelog
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"

          # Try to extract the section for this version from CHANGELOG.md
          if [ -f "CHANGELOG.md" ]; then
            # Extract content between this version and the previous version header
            NOTES=$(awk "/^## \[?${VERSION}\]?|^## \[?v${VERSION}\]?/{flag=1; next} /^## \[?[0-9]+\.[0-9]+/{if(flag) exit} flag" CHANGELOG.md)
            
            if [ -n "$NOTES" ]; then
              echo "Found changelog entry for version $VERSION"
              # Save to file to handle multiline
              echo "$NOTES" > release_notes.md
            else
              echo "No changelog entry found for version $VERSION, using auto-generated notes"
              echo "## What's Changed" > release_notes.md
              echo "" >> release_notes.md
              echo "See the [full changelog](https://github.com/${{ github.repository }}/commits/v$VERSION) for details." >> release_notes.md
            fi
          else
            echo "No CHANGELOG.md found, using auto-generated notes"
            echo "## What's Changed" > release_notes.md
            echo "" >> release_notes.md
            echo "See the [full changelog](https://github.com/${{ github.repository }}/commits/v$VERSION) for details." >> release_notes.md
          fi

          # Add download section
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Downloads" >> release_notes.md
          echo "" >> release_notes.md
          echo "| Platform | Format | File |" >> release_notes.md
          echo "|----------|--------|------|" >> release_notes.md
          echo "| macOS | DMG | \`Nostr Nations_${VERSION}_x64.dmg\` |" >> release_notes.md
          echo "| macOS | App Bundle | \`Nostr Nations.app.tar.gz\` |" >> release_notes.md
          echo "| Windows | NSIS Installer | \`Nostr Nations_${VERSION}_x64-setup.exe\` |" >> release_notes.md
          echo "| Windows | MSI Installer | \`Nostr Nations_${VERSION}_x64_en-US.msi\` |" >> release_notes.md
          echo "| Linux | Debian/Ubuntu | \`nostr-nations_${VERSION}_amd64.deb\` |" >> release_notes.md
          echo "| Linux | AppImage | \`nostr-nations_${VERSION}_amd64.AppImage\` |" >> release_notes.md
          echo "| Linux | RPM | \`nostr-nations-${VERSION}-1.x86_64.rpm\` |" >> release_notes.md

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Nostr Nations ${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          draft: true
          prerelease: ${{ contains(github.ref_name, '-alpha') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build macOS
  build-macos:
    name: Build macOS
    needs: create-release
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: macos-release-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            macos-release-cargo-registry-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: src-tauri/target
          key: macos-release-cargo-build-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            macos-release-cargo-build-

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Build Tauri app
        run: npx tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # macOS code signing (optional)
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Compress app bundle
        run: |
          cd src-tauri/target/release/bundle/macos
          tar -czf "Nostr Nations.app.tar.gz" "Nostr Nations.app"

      - name: Upload macOS DMG
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: src-tauri/target/release/bundle/dmg/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload macOS App Bundle
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: src-tauri/target/release/bundle/macos/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build Windows
  build-windows:
    name: Build Windows
    needs: create-release
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: windows-release-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            windows-release-cargo-registry-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: src-tauri/target
          key: windows-release-cargo-build-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            windows-release-cargo-build-

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Build Tauri app
        run: npx tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          # Windows code signing (optional)
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}

      - name: Upload Windows NSIS installer
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: src-tauri/target/release/bundle/nsis/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows MSI installer
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: src-tauri/target/release/bundle/msi/*.msi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build Linux
  build-linux:
    name: Build Linux
    needs: create-release
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: linux-release-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            linux-release-cargo-registry-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: src-tauri/target
          key: linux-release-cargo-build-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            linux-release-cargo-build-

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Build Tauri app
        run: npx tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Upload Linux DEB
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: src-tauri/target/release/bundle/deb/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux AppImage
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: src-tauri/target/release/bundle/appimage/*.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux RPM
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: src-tauri/target/release/bundle/rpm/*.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Publish release (make it non-draft)
  publish-release:
    name: Publish Release
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Publish release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release published
        run: |
          echo "Release ${{ github.ref_name }} has been published!"
          echo "View at: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
